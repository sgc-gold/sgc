name: Update Tanaka Prices

on:
  schedule:
    - cron: '40 0 * * *'   # 日本時間 9:40（UTC 0:30）
    - cron: '10 5 * * *'    # 日本時間 14:10（UTC 5:00）
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリを取得
        uses: actions/checkout@v4

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 必要パッケージをインストール
        run: |
          pip install requests beautifulsoup4 lxml

      - name: 田中貴金属の価格を取得してprice.htmlを更新
        run: |
          python3 << 'PYCODE'
          import requests, datetime, os
          from bs4 import BeautifulSoup

          URL = "https://gold.tanaka.co.jp/commodity/souba/"

          html = requests.get(URL)
          html.encoding = html.apparent_encoding
          soup = BeautifulSoup(html.text, "lxml")

          def parse_price(cell):
              return int(cell.text.replace("円","").replace(",","").strip())

          rows = soup.select("#metal_price tr")[1:]
          metals = {}
          for r in rows:
              name = r.select_one(".metal_name").text.strip().split()[0]
              retail = parse_price(r.select_one(".retail_tax"))
              retail_diff = r.select_one(".retail_ratio").text.strip()
              purchase = parse_price(r.select_one(".purchase_tax"))
              purchase_diff = r.select_one(".purchase_ratio").text.strip()
              metals[name] = {
                  "retail": retail,
                  "retail_diff": retail_diff,
                  "purchase": purchase,
                  "purchase_diff": purchase_diff
              }

          now = datetime.datetime.utcnow() + datetime.timedelta(hours=9)
          timestamp = now.strftime("%Y/%m/%d %H:%M")

          # price.html のパス
          file_path = "price.html"

          # 前回（9:30）のデータ保持用
          ref_file = "tanaka_0930.txt"

          # price.htmlに書き出し
          html_content = f"""<!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <title>貴金属価格情報</title>
            <style>
              body {{ font-family: Arial, sans-serif; margin: 20px; }}
              table {{ border-collapse: collapse; width: 100%; }}
              th, td {{ border: 1px solid #ccc; padding: 8px; text-align: right; }}
              th {{ background-color: #f4f4f4; }}
              td:first-child {{ text-align: left; }}
            </style>
          </head>
          <body>
            <h2>貴金属価格情報 <span class="eng">Market</span></h2>
            <p>最終更新：{timestamp}</p>
            <table>
              <tr>
                <th>品目</th>
                <th>小売価格（税込）</th>
                <th>前日比</th>
                <th>買取価格（税込）</th>
                <th>前日比</th>
                <th>9:30比</th>
              </tr>
          """

          nine_thirty_data = {}
          if now.hour == 9 and now.minute >= 30 and now.minute < 60:
              # 9:30の更新 → 記録保存
              for k, v in metals.items():
                  nine_thirty_data[k] = v["purchase"]
              with open(ref_file, "w", encoding="utf-8") as f:
                  for k, v in nine_thirty_data.items():
                      f.write(f"{k}:{v}\n")

          elif now.hour == 14:
              # 14:00の更新 → 9:30比を出す
              if os.path.exists(ref_file):
                  with open(ref_file, "r", encoding="utf-8") as f:
                      for line in f:
                          k, v = line.strip().split(":")
                          nine_thirty_data[k] = int(v)

          for name, v in metals.items():
              diff_0930 = ""
              if name in nine_thirty_data:
                  diff_val = v["purchase"] - nine_thirty_data[name]
                  sign = "+" if diff_val > 0 else ""
                  diff_0930 = f"{sign}{diff_val:,} 円"
              html_content += f"""
              <tr>
                <td>{name}</td>
                <td>{v['retail']:,} 円</td>
                <td>{v['retail_diff']}</td>
                <td>{v['purchase']:,} 円</td>
                <td>{v['purchase_diff']}</td>
                <td>{diff_0930}</td>
              </tr>
              """

          html_content += """
            </table>
          </body>
          </html>
          """

          with open(file_path, "w", encoding="utf-8") as f:
              f.write(html_content.strip())

          PYCODE

      - name: 更新をコミットして反映
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add price.html tanaka_0930.txt || true
          git commit -m "Update Tanaka prices [auto]" || exit 0
          git push

      - name: ページ再公開
        uses: actions/deploy-pages@v4
