<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>宝石重量自動計算</title>
<style>
  /* 全体スタイル */
  body {
    font-family: Georgia, 'Times New Roman', serif;
    background: #f5f5f5;
    color: #333;
    padding: 20px;
    display: flex;
    justify-content: center;
  }

  /* カード風フォーム */
  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    padding: 20px;
    max-width: 400px;
    width: 100%;
  }

  h2 {
    text-align: center;
    font-weight: normal;
    color: #222;
  }

  label {
    display: block;
    margin-top: 12px;
    font-weight: bold;
    color: #555;
  }

  select, input {
    font-size: 1rem;
    padding: 8px;
    width: 100%;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 4px;
    box-sizing: border-box;
    transition: 0.3s;
  }

  select:focus, input:focus {
    border-color: #9c27b0;
    box-shadow: 0 0 5px rgba(156,39,176,0.3);
    outline: none;
  }

  .row {
    margin-bottom: 12px;
  }

  button {
    margin-top: 12px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #9c27b0, #6a1b9a);
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    width: 100%;
    transition: 0.3s;
  }

  button:hover {
    background: linear-gradient(135deg, #7b1fa2, #4a148c);
  }

  /* 結果表示 */
  .result {
    text-align: center;
    margin-top: 16px;
    font-size: 1.4rem;
    font-weight: bold;
    color: #222;
  }

  .result span.unit {
    font-size: 0.8rem;
    color: #777;
  }

  /* 管理者用リンク（控えめ表示） */
  .admin-link {
    display: block;
    text-align: right;
    margin-top: 20px;
    font-size: 0.75rem;
    color: #999;
    text-decoration: none;
  }

  .admin-link:hover {
    color: #9c27b0;
  }

  @media(max-width: 480px){
    .card { padding: 16px; }
    .result { font-size: 1.2rem; }
  }
</style>
</head>
<body>

<div class="card">
  <h2>宝石重量 計算ツール</h2>

  <div class="row">
    <label>石の種類（比重）</label>
    <select id="gemstone"></select>
  </div>

  <div class="row">
    <label>カット</label>
    <select id="cut"></select>
  </div>

  <div id="dimensions"></div>

  <div class="row">
    <button id="calcBtn">重量計算</button>
  </div>

  <div class="result">
    <span id="resultG">0.000</span> <span class="unit">g</span> ／
    <span id="resultCt">0.000</span> <span class="unit">ct</span>
  </div>

  <a href="register.html" class="admin-link">※ 管理者用データ登録</a>
</div>

<script>
let gemstones=[], cuts=[], models={}, calibrations=[];

// ----------------- データ読み込み -----------------
async function loadData() {
  const g = await fetch('./data/gemstones.json').then(r=>r.json());
  gemstones = g.gemstones;

  const c = await fetch('./data/cuts.json').then(r=>r.json());
  cuts = c.cuts;

  const m = await fetch('./data/models.json').then(r=>r.json());
  models = {};
  m.models.forEach(md=>models[md.id]=md);

  await loadCalibrations();

  populateGemstones();
  populateCuts();
  updateDimensionFields();
}

async function loadCalibrations() {
  try {
    const res = await fetch('./data/calibrations.json');
    const data = await res.json();
    calibrations = data.calibrations || [];
  } catch (e) {
    calibrations = [];
  }
}

// ----------------- セレクトボックス -----------------
function populateGemstones() {
  const sel = document.getElementById("gemstone");
  gemstones.forEach(st=>{
    const opt = document.createElement("option");
    opt.value = st.id;
    opt.textContent = `${st.name_ja} (SG:${st.sg_std})`;
    sel.appendChild(opt);
  });
}

function populateCuts() {
  const sel = document.getElementById("cut");
  cuts.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name_ja;
    sel.appendChild(opt);
  });
  sel.addEventListener("change", updateDimensionFields);
}

// ----------------- 寸法入力欄 -----------------
function updateDimensionFields() {
  const cutId = document.getElementById("cut").value;
  const cut = cuts.find(c=>c.id===cutId);
  const fields = cut.measurement_fields;

  const area = document.getElementById("dimensions");
  area.innerHTML = "";
  fields.forEach(f=>{
    const label = {
      d: "直径(mm)",
      D: "厚み/全高(mm)",
      L: "縦(mm)",
      W: "横(mm)",
      a: "辺長(mm)",
      r: "最大半径(mm)",
      h: "高さ(mm)",
      h_half: "片側高さ(mm)",
      A: "底面積(mm²)",
      split_ratio: "上部割合(0.4〜0.7推奨)"
    }[f] || f;

    const row = document.createElement("div");
    row.className="row";
    row.innerHTML = `<label>${label}</label>
      <input id="dim_${f}" type="number" step="0.01" value="${f==='split_ratio' ? 0.6:''}">`;
    area.appendChild(row);
  });
}

// ----------------- 重量計算 -----------------
document.getElementById("calcBtn").addEventListener("click", ()=>{
  const stoneId = gemstone.value;
  const stone = gemstones.find(s=>s.id===stoneId);
  const cutId = cut.value;
  const cutObj = cuts.find(c=>c.id===cutId);
  const model = models[cutObj.model];

  const args = cutObj.measurement_fields.map(f=>{
    const v = parseFloat(document.getElementById("dim_"+f).value);
    return isNaN(v)?0:v;
  });

  let V = eval(model.formula_js)(...args);
  V *= cutObj.correction_factor;
  let massG = stone.sg_std * V / 1000;

  // calibrations.json 補正係数を適用
  const relevant = calibrations.filter(c=>c.stone===stoneId && c.cut===cutId);
  if(relevant.length>0){
    const avg_factor = relevant.reduce((sum,c)=>sum+c.correction_factor,0)/relevant.length;
    massG *= avg_factor;
  }

  const massCt = massG / 0.2;
  resultG.textContent = massG.toFixed(3);
  resultCt.textContent = massCt.toFixed(3);
});

// ----------------- 初期化 -----------------
loadData();
</script>

</body>
</html>
