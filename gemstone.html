<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>宝石重量自動計算</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: 'Helvetica', Arial, sans-serif;
    background: linear-gradient(to right, #f0f4f8, #d9e2ec);
    padding: 20px;
    margin: 0;
  }
  h2 {
    text-align: center;
    color: #1f2937;
    margin-bottom: 20px;
  }
  .card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    padding: 20px;
    margin: 10px auto;
    max-width: 600px;
  }
  label {
    display: block;
    margin-top: 12px;
    font-weight: bold;
    color: #334155;
  }
  select, button {
    font-size: 1.1rem;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    background: #f8fafc;
    margin-top: 6px;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    cursor: pointer;
    background: #3b82f6;
    color: #fff;
    border: none;
    transition: 0.3s;
  }
  button:hover {
    background: #2563eb;
  }
  #dimensions .row {
    margin-bottom: 10px;
  }
  #result {
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: #ef4444;
  }
  .admin-link {
    display: block;
    text-align: right;
    font-size: 0.8rem;
    margin-top: 15px;
    color: #94a3b8;
  }
  .admin-link a {
    color: #64748b;
    text-decoration: none;
  }
  .admin-link a:hover {
    text-decoration: underline;
  }
  @media (max-width: 480px) {
    body { padding: 10px; }
    h2 { font-size: 1.4rem; }
    select, button { font-size: 1rem; padding: 6px 10px; }
    #result { font-size: 1.5rem; }
  }
</style>
</head>
<body>

<h2>宝石重量 計算ツール</h2>

<div class="card">
  <div class="row">
    <label>石の種類（比重）</label>
    <select id="gemstone"></select>
  </div>

  <div class="row">
    <label>カット</label>
    <select id="cut"></select>
  </div>

  <div id="dimensions"></div>

  <div class="row">
    <button id="calcBtn">重量計算</button>
    <button id="resetBtn" style="background:#f87171;margin-top:8px;">リセット</button>
  </div>
</div>

<div class="card" id="result">
  <span id="resultG">0.000 g</span> ／ <span id="resultCt">0.000 ct</span>
</div>

<div class="admin-link">
  <span>管理者用: <a href="register.html" target="_blank">補正データ登録ページ</a></span>
</div>

<script>
let gemstones=[], cuts=[], models={}, calibrations=[];

// ----------------- データ読み込み -----------------
async function loadData() {
  const g = await fetch('./data/gemstones.json').then(r=>r.json());
  gemstones = g.gemstones;

  const c = await fetch('./data/cuts.json').then(r=>r.json());
  cuts = c.cuts;

  const m = await fetch('./data/models.json').then(r=>r.json());
  models = {};
  m.models.forEach(md=>models[md.id]=md);

  await loadCalibrations();

  populateGemstones();
  populateCuts();
  updateDimensionFields();
}

// ----------------- calibrations.json 読み込み -----------------
async function loadCalibrations() {
  try {
    const res = await fetch('./data/calibrations.json');
    const data = await res.json();
    calibrations = data.calibrations || [];
  } catch (e) {
    calibrations = [];
  }
}

// ----------------- セレクトボックス -----------------
function populateGemstones() {
  const sel = document.getElementById("gemstone");
  gemstones.forEach(st=>{
    const opt = document.createElement("option");
    opt.value = st.id;
    opt.textContent = `${st.name_ja} (SG:${st.sg_std})`;
    sel.appendChild(opt);
  });
}

function populateCuts() {
  const sel = document.getElementById("cut");
  cuts.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name_ja;
    sel.appendChild(opt);
  });
  sel.addEventListener("change", updateDimensionFields);
}

// ----------------- 寸法入力欄（選択式） -----------------
function updateDimensionFields() {
  const cutId = document.getElementById("cut").value;
  const cut = cuts.find(c=>c.id===cutId);
  if(!cut) return;
  const fields = cut.measurement_fields;

  const area = document.getElementById("dimensions");
  area.innerHTML = "";

  fields.forEach(f=>{
    const row = document.createElement("div");
    row.className = "row";

    // 1〜30mmまで0.5刻み
    let options = '';
    for(let i=1;i<=30;i+=0.5){
      options += `<option value="${i}">${i} mm</option>`;
    }

    const label = {
      d: "直径(mm)",
      D: "厚み/全高(mm)",
      L: "縦(mm)",
      W: "横(mm)",
      a: "辺長(mm)",
      r: "最大半径(mm)",
      h: "高さ(mm)",
      h_half: "片側高さ(mm)",
      A: "底面積(mm²)",
      split_ratio: "上部割合(0.4〜0.7)"
    }[f] || f;

    if(f==='split_ratio'){
      row.innerHTML = `<label>${label}</label>
        <select id="dim_${f}">
          <option value="0.4">0.4</option>
          <option value="0.5">0.5</option>
          <option value="0.6" selected>0.6</option>
          <option value="0.7">0.7</option>
        </select>`;
    } else {
      row.innerHTML = `<label>${label}</label>
        <select id="dim_${f}">${options}</select>`;
    }

    area.appendChild(row);
  });
}

// ----------------- 重量計算 -----------------
document.getElementById("calcBtn").addEventListener("click", ()=>{
  const stoneId = gemstone.value;
  const stone = gemstones.find(s=>s.id===stoneId);
  const cutId = cut.value;
  const cutObj = cuts.find(c=>c.id===cutId);
  const model = models[cutObj.model];

  const args = cutObj.measurement_fields.map(f=>{
    const v = parseFloat(document.getElementById("dim_"+f).value);
    return isNaN(v)?0:v;
  });

  let V = eval(model.formula_js)(...args);
  V *= cutObj.correction_factor;
  let massG = stone.sg_std * V / 1000;

  const relevant = calibrations.filter(c=>c.stone===stoneId && c.cut===cutId);
  if(relevant.length>0){
    const avg_factor = relevant.reduce((sum,c)=>sum+c.correction_factor,0)/relevant.length;
    massG *= avg_factor;
  }

  const massCt = massG / 0.2;
  resultG.textContent = massG.toFixed(3)+" g";
  resultCt.textContent = massCt.toFixed(3)+" ct";
});

// ----------------- リセットボタン -----------------
document.getElementById("resetBtn").addEventListener("click", ()=>{
  gemstone.selectedIndex = 0;
  cut.selectedIndex = 0;
  updateDimensionFields();
  resultG.textContent = "0.000 g";
  resultCt.textContent = "0.000 ct";
});

// ----------------- 初期化 -----------------
loadData();
</script>

</body>
</html>
