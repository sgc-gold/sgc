<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ€ã‚¤ãƒ¤ç›¸å ´æ¤œç´¢ï¼ˆè¤‡åˆæ¡ä»¶ï¼‰</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: "Noto Sans JP", sans-serif; margin: 20px; }
  label { margin-right: 10px; }
  select, input[type=number], input[type=text] { margin-right: 15px; margin-bottom:10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
  th { background-color: #f0f0f0; }
  .details { display: none; font-size: 12px; background-color: #fafafa; }
  .toggle-btn { cursor: pointer; color: #0066cc; font-size: 12px; }
  @media(max-width:768px){ table, th, td { font-size: 12px; } }
  .avg-price { margin-top: 10px; font-weight: bold; }
  .calc-row { margin-top: 10px; }
  .calc-row input, .calc-row select { width: 80px; }
</style>
</head>
<body>
<h1>ãƒ€ã‚¤ãƒ¤ç›¸å ´æ¤œç´¢</h1>

<!-- ğŸ”¹ æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
<label>é–‹å‚¬æ—¥:</label>
<select id="dateSelect"><option value="">å…¨ã¦</option></select><br>

<label>Ct:</label>
<input type="number" id="ctInput" step="0.001" value="0.725"><br>

<label>æœ€å°ã‚«ãƒ©ãƒƒãƒˆ:</label>
<input type="number" id="caratMin" step="0.01" value="0.700">
<label>æœ€å¤§ã‚«ãƒ©ãƒƒãƒˆ:</label>
<input type="number" id="caratMax" step="0.01" value="0.799"><br>

<label>ã‚«ãƒ©ãƒ¼:</label>
<select id="colorSelect"><option value="">å…¨ã¦</option></select>
<label>ã‚¯ãƒ©ãƒªãƒ†ã‚£:</label>
<select id="claritySelect"><option value="">å…¨ã¦</option></select><br>

<label>ã‚«ãƒƒãƒˆ:</label>
<select id="cutSelect"><option value="">å…¨ã¦</option></select>
<label>å½¢çŠ¶:</label>
<select id="shapeSelect"><option value="">å…¨ã¦</option></select>
<label>è›å…‰æ€§:</label>
<select id="fluorescenceSelect"><option value="">å…¨ã¦</option></select><br>

<button onclick="search()">æ¤œç´¢</button>

<!-- ğŸ”¹ å¹³å‡å˜ä¾¡ãƒ»é‡‘é¡è¨ˆç®— -->
<div class="avg-price" id="avgPriceDiv"></div>
<div class="calc-row">
  æ›ç‡ï¼š
  <select id="kakeritsu">
    <option value="5">5æ›ã‘</option>
    <option value="6">6æ›ã‘</option>
    <option value="7">7æ›ã‘</option>
    <option value="8">8æ›ã‘</option>
    <option value="9">9æ›ã‘</option>
  </select>
  é‡‘é¡: <span id="calcPrice">0</span> å††
</div>

<!-- ğŸ”¹ çµæœè¡¨ç¤º -->
<table id="resultTable">
  <thead>
    <tr>
      <th>é–‹å‚¬æ—¥</th><th>çŸ³ç›®(ct)</th><th>ã‚¬ã‚¤å˜ä¾¡(å††)</th><th>ã‚«ãƒ©ãƒ¼</th><th>ã‚¯ãƒ©ãƒªãƒ†ã‚£</th>
      <th>ã‚«ãƒƒãƒˆ</th><th>è›å…‰æ€§</th><th>å½¢çŠ¶</th><th>å‚™è€ƒ</th>
      <th>è©³ç´°</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAh46ZVl6ICR9ynh6G8VZn6RlApcqpSq48",
  authDomain: "sgc-diamond-db.firebaseapp.com",
  projectId: "sgc-diamond-db",
  storageBucket: "sgc-diamond-db.firebasestorage.app",
  messagingSenderId: "552067864642",
  appId: "1:552067864642:web:c4cb10821bdd7b1a85f5db",
  measurementId: "G-DNMP8JJNB7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ğŸ”¹ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
async function loadFilters() {
  const snapshot = await db.collection("Diamonds").get();
  const dates = new Set(), colors = new Set(), clarities = new Set(), cuts = new Set(), shapes = new Set(), fluorescences = new Set();
  snapshot.forEach(doc=>{
    const d = doc.data();
    if(d.date) dates.add(d.date);
    if(d.color) colors.add(d.color);
    if(d.clarity) clarities.add(d.clarity);
    if(d.cut) cuts.add(d.cut);
    if(d.shape) shapes.add(d.shape);
    if(d.fluorescence) fluorescences.add(d.fluorescence);
  });
  Array.from(dates).sort().forEach(v=>document.getElementById("dateSelect").appendChild(new Option(v,v)));
  Array.from(colors).sort().forEach(v=>document.getElementById("colorSelect").appendChild(new Option(v,v)));
  Array.from(clarities).sort().forEach(v=>document.getElementById("claritySelect").appendChild(new Option(v,v)));
  Array.from(cuts).sort().forEach(v=>document.getElementById("cutSelect").appendChild(new Option(v,v)));
  Array.from(shapes).sort().forEach(v=>document.getElementById("shapeSelect").appendChild(new Option(v,v)));
  Array.from(fluorescences).sort().forEach(v=>document.getElementById("fluorescenceSelect").appendChild(new Option(v,v)));
}
loadFilters();

// ğŸ”¹ Ctå…¥åŠ›ã§è‡ªå‹•è¨­å®š
document.getElementById("ctInput").addEventListener("input", ()=>{
  const ct = parseFloat(document.getElementById("ctInput").value);
  if(!isNaN(ct)){
    document.getElementById("caratMin").value = (Math.floor(ct*10)/10).toFixed(3);
    document.getElementById("caratMax").value = (Math.floor(ct*10)/10 + 0.099).toFixed(3);
  }
});

// ğŸ”¹ æ¤œç´¢é–¢æ•°
async function search(){
  let query = db.collection("Diamonds");
  const date = document.getElementById("dateSelect").value;
  if(date) query = query.where("date", ">=", date);
  const caratMin = parseFloat(document.getElementById("caratMin").value);
  const caratMax = parseFloat(document.getElementById("caratMax").value);
  query = query.where("carat", ">=", caratMin).where("carat","<=",caratMax);
  
  const color = document.getElementById("colorSelect").value;
  if(color) query = query.where("color","==",color);
  const clarity = document.getElementById("claritySelect").value;
  if(clarity) query = query.where("clarity","==",clarity);
  const cut = document.getElementById("cutSelect").value;
  if(cut) query = query.where("cut","==",cut);
  const shape = document.getElementById("shapeSelect").value;
  if(shape) query = query.where("shape","==",shape);
  const fluorescence = document.getElementById("fluorescenceSelect").value;
  if(fluorescence) query = query.where("fluorescence","==",fluorescence);

  const snapshot = await query.get();
  const tbody = document.getElementById("resultBody");
  tbody.innerHTML = "";
  let totalPricePerCarat = 0;
  let count = 0;

  snapshot.forEach(doc=>{
    const d = doc.data();
    totalPricePerCarat += d.pricePerCarat || 0;
    count++;
    const detailHtml = `
      <tr class="details">
        <td colspan="10">
          ç›´å¾„æœ€å°(mm): ${d.diameterMin || ""}, ç›´å¾„æœ€å¤§(mm): ${d.diameterMax || ""}, ä¸æ­£å††ç‡: ${d.unevenRate || ""} <br>
          é«˜ã•(mm): ${d.height || ""}, å…¨é«˜æ¯”(%): ${d.heightRatio || ""}
        </td>
      </tr>
    `;
    tbody.innerHTML += `
      <tr>
        <td>${d.date || ""}</td>
        <td>${d.carat || ""}</td>
        <td>${d.pricePerCarat || ""}</td>
        <td>${d.color || ""}</td>
        <td>${d.clarity || ""}</td>
        <td>${d.cut || ""}</td>
        <td>${d.fluorescence || ""}</td>
        <td>${d.shape || ""}</td>
        <td>${d.notes || ""}</td>
        <td><span class="toggle-btn" onclick="this.parentElement.parentElement.nextElementSibling.style.display=(this.parentElement.parentElement.nextElementSibling.style.display==='none'?'table-row':'none')">è©³ç´°</span></td>
      </tr>
      ${detailHtml}
    `;
  });

  // å¹³å‡å˜ä¾¡è¡¨ç¤º
  const avgPriceDiv = document.getElementById("avgPriceDiv");
  const avgPrice = count? (totalPricePerCarat/count).toFixed(0) : 0;
  avgPriceDiv.innerText = `å¹³å‡å˜ä¾¡ï¼šï¿¥${avgPrice}`;

  // æ›ç‡è¨ˆç®—
  const ctValue = parseFloat(document.getElementById("ctInput").value);
  const kake = parseInt(document.getElementById("kakeritsu").value);
  document.getElementById("calcPrice").innerText = (avgPrice*ctValue*kake).toLocaleString();
}

// æ›ç‡å¤‰æ›´æ™‚ã«å†è¨ˆç®—
document.getElementById("kakeritsu").addEventListener("change", ()=>{
  const avgPriceText = document.getElementById("avgPriceDiv").innerText.replace(/\D/g,'');
  const avgPrice = parseInt(avgPriceText) || 0;
  const ctValue = parseFloat(document.getElementById("ctInput").value);
  const kake = parseInt(document.getElementById("kakeritsu").value);
  document.getElementById("calcPrice").innerText = (avgPrice*ctValue*kake).toLocaleString();
});
</script>
</body>
</html>
