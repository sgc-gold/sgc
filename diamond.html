<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ダイヤ相場検索</title>
<style>
/* 元コードと同じ CSS をここに貼り付け */
</style>
</head>
<body>
<div class="container">
  <h2>ダイヤ検索フォーム</h2>

  <!-- ここも元コードと同じ HTML -->
  <!-- カラットセット + 最小～最大 -->
  <div class="flex-row">
    <label for="mainCarat">カラット（ct）</label>
    <div id="caratSetRow">
      <input type="text" id="mainCarat" placeholder="例：0.345">
      <button type="button" id="setCarat">セット</button>
      <div id="caratRange">
        <input type="text" id="minCarat" placeholder="最小ct">
        <span>～</span>
        <input type="text" id="maxCarat" placeholder="最大ct">
      </div>
    </div>
  </div>

  <!-- 検索フォーム（元コードと同じ） -->
  <div class="flex-row" style="align-items:center;">
    <label for="dateSelect">開催日</label>
    <select id="dateSelect"><option value="">すべて</option></select>
    <span style="margin-left:0.5rem; color:#555; font-size:0.9rem;">※選択日以降で検索</span>
  </div>
  <div class="flex-row">
    <label for="colorSelect">カラー</label>
    <select id="colorSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="claritySelect">クラリティ</label>
    <select id="claritySelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="cutSelect">カット</label>
    <select id="cutSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="fluorescenceSelect">蛍光性</label>
    <select id="fluorescenceSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="shapeSelect">形状</label>
    <select id="shapeSelect"><option value="">すべて</option></select>
  </div>

  <div class="flex-row">
    <label for="keyword">フリーワード</label>
    <input type="text" id="keyword" placeholder="例：D VS1 GD">
  </div>

  <div class="flex-row" style="justify-content:center; gap:1rem;">
    <button id="searchButton">検索</button>
    <button id="clearButton">クリア</button>
  </div>

 <div id="loadingSpinner" style="display:none; justify-content:center; margin-top:1rem;">
   <div class="spinner"></div>
 </div>

  <!-- 結果テーブル -->
  <table id="resultTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>カラー</th>
        <th>クラリティ</th>
        <th>カット</th>
        <th>蛍光性</th>
        <th>形状</th>
        <th>カラット</th>
        <th>ガイ単価</th>
        <th>金額</th>
        <th>備考</th>
        <th>詳細</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>
</div>

<script>
// ---------------------
// カラットセット機能
// ---------------------
document.getElementById("setCarat").addEventListener("click", ()=> {
  let c = parseFloat(document.getElementById("mainCarat").value);
  if(isNaN(c)) return alert("数値を入力してください");
  let min = Math.floor(c*10)/10;
  let max = min + 0.099;
  document.getElementById("minCarat").value = min.toFixed(3);
  document.getElementById("maxCarat").value = max.toFixed(3);
});

// ---------------------
// JSON 取得 & フィルター選択肢作成
// ---------------------
let diamondData = [];
async function populateFilters(){
  const url = "https://raw.githubusercontent.com/sgc-gold/sgc/main/data/diamonds.json";
  const resp = await fetch(url);
  diamondData = await resp.json();

  const dates=new Set(), colors=new Set(), clarities=new Set(), cuts=new Set(), fluo=new Set(), shapes=new Set();

  diamondData.forEach(d => {
    if(d.date) dates.add(d.date.split(" ")[0]);
    if(d.color) colors.add(d.color);
    if(d.clarity) clarities.add(d.clarity);
    if(d.cut) cuts.add(d.cut);
    if(d.fluorescence) fluo.add(d.fluorescence);
    if(d.shape) shapes.add(d.shape);
  });

  const addOption=(sel,val)=>{ sel.appendChild(new Option(val,val)); };
  Array.from(dates).sort().forEach(d=>addOption(document.getElementById("dateSelect"),d));
  Array.from(colors).sort().forEach(c=>addOption(document.getElementById("colorSelect"),c));
  Array.from(clarities).sort().forEach(c=>addOption(document.getElementById("claritySelect"),c));
  Array.from(cuts).sort().forEach(c=>addOption(document.getElementById("cutSelect"),c));
  Array.from(fluo).sort().forEach(f=>addOption(document.getElementById("fluorescenceSelect"),f));
  Array.from(shapes).sort().forEach(s=>addOption(document.getElementById("shapeSelect"),s));
}
populateFilters();

// ---------------------
// 検索処理（件数表示＋ページネーション）
// ---------------------
document.getElementById("searchButton").addEventListener("click", ()=> {
  const spinner = document.getElementById("loadingSpinner");
  spinner.style.display = "flex";

  setTimeout(()=> { // 🔹非同期感出すための少しの遅延
    const minC = parseFloat(document.getElementById("minCarat").value) || 0;
    const maxC = parseFloat(document.getElementById("maxCarat").value) || 999;
    const dateVal = document.getElementById("dateSelect").value;
    const colorVal = document.getElementById("colorSelect").value;
    const clarityVal = document.getElementById("claritySelect").value;
    const cutVal = document.getElementById("cutSelect").value;
    const fluVal = document.getElementById("fluorescenceSelect").value;
    const shapeVal = document.getElementById("shapeSelect").value;
    const keyword = document.getElementById("keyword").value.trim().toLowerCase();

    const tbody = document.getElementById("resultBody");
    tbody.innerHTML = "";

    // 件数表示エリア
    let countTop = document.getElementById("resultCountTop");
    let countBottom = document.getElementById("resultCountBottom");
    if(!countTop){
      countTop = document.createElement("div");
      countTop.id = "resultCountTop";
      countTop.className = "result-count stylish-count";
      tbody.parentElement.insertAdjacentElement("beforebegin", countTop);
    }
    if(!countBottom){
      countBottom = document.createElement("div");
      countBottom.id = "resultCountBottom";
      countBottom.className = "result-count stylish-count";
      tbody.parentElement.insertAdjacentElement("afterend", countBottom);
    }

    // 絞り込み
    const results = diamondData.filter(d => {
      const c = parseFloat(d.carat) || 0;
      if(c < minC || c > maxC) return false;
      if(dateVal && d.date.split(" ")[0] < dateVal) return false;
      if(colorVal && d.color != colorVal) return false;
      if(clarityVal && d.clarity != clarityVal) return false;
      if(cutVal && d.cut != cutVal) return false;
      if(fluVal && d.fluorescence != fluVal) return false;
      if(shapeVal && d.shape != shapeVal) return false;
      if(keyword){
        const fields = [d.color,d.clarity,d.cut,d.shape,d.notes].join(" ").toLowerCase();
        if(!keyword.split(" ").every(k=>fields.includes(k))) return false;
      }
      return true;
    });

    // ページネーション
    const perPage = 100;
    let currentPage = 1;
    const totalPages = Math.ceil(results.length/perPage);

    function renderPage(page){
      tbody.innerHTML="";
      const start = (page-1)*perPage;
      const end = start+perPage;
      results.slice(start,end).forEach(d=>{
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.date.split(" ")[0]||""}</td>
          <td>${d.color||""}</td>
          <td>${d.clarity||""}</td>
          <td>${d.cut||""}</td>
          <td>${d.fluorescence||""}</td>
          <td>${d.shape||""}</td>
          <td>${parseFloat(d.carat)?.toFixed(3)||""}</td>
          <td>${parseFloat(d.pricePerCarat)?.toLocaleString()||""}</td>
          <td>${(parseFloat(d.pricePerCarat)*parseFloat(d.carat))?.toLocaleString()||""}</td>
          <td>${d.notes||""}</td>
          <td><span class="detailToggle">詳細</span></td>
        `;
        tbody.appendChild(row);

        // 詳細行
        const detailRow = document.createElement("tr");
        detailRow.classList.add("detailsRow");

        let unevenRate="", heightRatio="";
        if(d.diameterMin && d.diameterMax){
          const min=parseFloat(d.diameterMin), max=parseFloat(d.diameterMax);
          const avg=(min+max)/2;
          unevenRate=(((max-min)/avg)*100).toFixed(2)+"%";
          if(d.height) heightRatio=((parseFloat(d.height)/avg)*100).toFixed(2)+"%";
        }

        detailRow.innerHTML=`
          <td colspan="11">
            直径（最小）: ${d.diameterMin||""}mm ー（最大）: ${d.diameterMax||""}mm ※ 高さ: ${d.height||""}mm<br>
            不正円率: ${unevenRate}　　全高比: ${heightRatio}
          </td>
        `;
        tbody.appendChild(detailRow);

        row.querySelector(".detailToggle").addEventListener("click", ()=> {
          detailRow.style.display = detailRow.style.display==="table-row"?"none":"table-row";
        });
      });

      const msg = results.length
        ? `🔹検索結果：<strong>${results.length.toLocaleString()}</strong> 件（${page}/${totalPages}ページ）`
        : `⚠ 該当するデータはありません。`;

      countTop.innerHTML=msg;
      countBottom.innerHTML=msg;
    }

    // ページ送り
    const pagination = document.getElementById("paginationArea") || document.createElement("div");
    pagination.id = "paginationArea";
    pagination.className = "pagination stylish-pagination";
    countBottom.insertAdjacentElement("afterend", pagination);

    function updatePagination(){
      pagination.innerHTML="";
      if(totalPages<=1) return;

      const prev=document.createElement("button");
      prev.textContent="← 前へ";
      prev.disabled=currentPage===1;
      prev.onclick=()=>{ currentPage--; renderPage(currentPage); updatePagination(); };

      const next=document.createElement("button");
      next.textContent="次へ →";
      next.disabled=currentPage===totalPages;
      next.onclick=()=>{ currentPage++; renderPage(currentPage); updatePagination(); };

      const info=document.createElement("span");
      info.innerHTML=`ページ ${currentPage} / ${totalPages}`;

      pagination.append(prev,info,next);
    }

    renderPage(1);
    updatePagination();
    spinner.style.display="none";

  }, 100); // 🔹小遅延
});

// ---------------------
// クリアボタン
// ---------------------
document.getElementById("clearButton").addEventListener("click", ()=> {
  ["minCarat","maxCarat","mainCarat","dateSelect","colorSelect","claritySelect","cutSelect","fluorescenceSelect","shapeSelect","keyword"]
    .forEach(id=>document.getElementById(id).value="");
  document.getElementById("resultBody").innerHTML="";
});
</script>
</body>
</html>
