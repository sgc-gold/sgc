<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ダイヤ相場検索（複合条件）</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f7fa;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      color: #004d40;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.3rem;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.6rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }

    .ct-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .ct-row input[type="number"] {
      flex: 1;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .ct-row button {
      background: linear-gradient(135deg, #bfa14a, #d4b95e);
      border: none;
      color: #fff;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .ct-row button:hover {
      opacity: 0.9;
    }

    #caratRange {
      font-size: 1rem;
      text-align: center;
      margin-bottom: 1rem;
      color: #333;
    }

    #keyword {
      width: 100%;
      padding: 0.6rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }

    .search-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .search-actions button {
      flex: 1;
      padding: 0.6rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 1rem;
    }

    #searchButton {
      background: linear-gradient(135deg, #bfa14a, #d4b95e);
      color: #fff;
    }

    #clearButton {
      background: #e0e0e0;
      color: #333;
    }

    #result {
      margin-top: 1.5rem;
    }

    .result-item {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 0.8rem;
      margin-bottom: 1rem;
      background: #fafafa;
    }

    .result-item .field {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.3rem;
    }

    @media (max-width: 600px) {
      .ct-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ダイヤ相場検索</h1>

    <!-- 上部 Ct 入力 -->
    <div class="ct-row">
      <input type="number" id="ctInput" step="0.001" placeholder="カラット (例: 0.725)">
      <button onclick="setCtRange()">セット</button>
    </div>

    <!-- 最小～最大カラット表示 -->
    <div id="caratRange">0.000 ～ 0.000</div>

    <!-- 検索フォーム -->
    <div class="input-group">
      <label>開催日</label>
      <select id="dateSelect">
        <option value="">全て</option>
      </select>
    </div>
    <div class="input-group">
      <label>カラー</label>
      <select id="colorSelect">
        <option value="">全て</option>
      </select>
    </div>
    <div class="input-group">
      <label>クラリティ</label>
      <select id="claritySelect">
        <option value="">全て</option>
      </select>
    </div>
    <div class="input-group">
      <label>カット</label>
      <select id="cutSelect">
        <option value="">全て</option>
      </select>
    </div>
    <div class="input-group">
      <label>蛍光性</label>
      <select id="fluorescenceSelect">
        <option value="">全て</option>
      </select>
    </div>
    <div class="input-group">
      <label>形状</label>
      <select id="shapeSelect">
        <option value="">全て</option>
      </select>
    </div>

    <!-- フリーワード検索 -->
    <div class="input-group">
      <label>フリーワード</label>
      <input type="text" id="keyword" placeholder="例: D VS1 GD">
    </div>

    <!-- 検索・クリアボタン -->
    <div class="search-actions">
      <button id="searchButton" onclick="search()">検索</button>
      <button id="clearButton" onclick="clearForm()">クリア</button>
    </div>

    <!-- 検索結果 -->
    <div id="result"></div>
  </div>

  <script>
    // Firebase 初期化（既存設定に置き換えてください）
    const firebaseConfig = {
      apiKey: "AIzaSyAh46ZVl6ICR9ynh6G8VZn6RlApcqpSq48",
      authDomain: "sgc-diamond-db.firebaseapp.com",
      projectId: "sgc-diamond-db",
      storageBucket: "sgc-diamond-db.firebasestorage.app",
      messagingSenderId: "552067864642",
      appId: "1:552067864642:web:c4cb10821bdd7b1a85f5db",
      measurementId: "G-DNMP8JJNB7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 最小～最大カラット計算
    function setCtRange() {
      const ct = parseFloat(document.getElementById("ctInput").value);
      if (isNaN(ct)) return;
    
      // 小数第一位で切り捨て
      const min = Math.floor(ct * 10) / 10;
      const max = min + 0.099;
    
      // 編集可能な input にセット
      document.getElementById("caratMin").value = min.toFixed(3);
      document.getElementById("caratMax").value = max.toFixed(3);
    }

    // フォームクリア
    function clearForm() {
      document.getElementById("ctInput").value = "";
      document.getElementById("caratRange").textContent = "0.000 ～ 0.000";
      document.getElementById("dateSelect").value = "";
      document.getElementById("colorSelect").value = "";
      document.getElementById("claritySelect").value = "";
      document.getElementById("cutSelect").value = "";
      document.getElementById("fluorescenceSelect").value = "";
      document.getElementById("shapeSelect").value = "";
      document.getElementById("keyword").value = "";
      document.getElementById("result").innerHTML = "";
    }

    // Firebase から選択肢を取得（サンプル。実際はdistinctな値を取得してください）
    async function populateSelects() {
      const snapshot = await db.collection("Diamonds").get();
      const dates = new Set();
      const colors = new Set();
      const clarities = new Set();
      const cuts = new Set();
      const fluorescences = new Set();
      const shapes = new Set();

      snapshot.forEach(doc => {
        const data = doc.data();
        dates.add(data.date);
        colors.add(data.color);
        clarities.add(data.clarity);
        cuts.add(data.cut);
        fluorescences.add(data.fluorescence);
        shapes.add(data.shape);
      });

      dates.forEach(d => {
        const option = document.createElement("option");
        option.value = d;
        option.textContent = d;
        document.getElementById("dateSelect").appendChild(option);
      });

      colors.forEach(v => document.getElementById("colorSelect").appendChild(new Option(v,v)));
      clarities.forEach(v => document.getElementById("claritySelect").appendChild(new Option(v,v)));
      cuts.forEach(v => document.getElementById("cutSelect").appendChild(new Option(v,v)));
      fluorescences.forEach(v => document.getElementById("fluorescenceSelect").appendChild(new Option(v,v)));
      shapes.forEach(v => document.getElementById("shapeSelect").appendChild(new Option(v,v)));
    }

    populateSelects();

    async function search() {
      const ctRangeText = document.getElementById("caratRange").textContent;
      const [minCt, maxCt] = ctRangeText.split("～").map(x=>parseFloat(x.trim()));
      const date = document.getElementById("dateSelect").value;
      const color = document.getElementById("colorSelect").value;
      const clarity = document.getElementById("claritySelect").value;
      const cut = document.getElementById("cutSelect").value;
      const fluorescence = document.getElementById("fluorescenceSelect").value;
      const shape = document.getElementById("shapeSelect").value;
      const keyword = document.getElementById("keyword").value.trim().toLowerCase().split(/\s+/);

      let query = db.collection("Diamonds");

      // 基本条件（カラット範囲）
      query = query.where("carat", ">=", minCt).where("carat", "<=", maxCt);

      // Firebase では空文字の場合は where しない
      if(date) query = query.where("date","==",date);
      if(color) query = query.where("color","==",color);
      if(clarity) query = query.where("clarity","==",clarity);
      if(cut) query = query.where("cut","==",cut);
      if(fluorescence) query = query.where("fluorescence","==",fluorescence);
      if(shape) query = query.where("shape","==",shape);

      const snapshot = await query.get();

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const textValues = `${data.color} ${data.clarity} ${data.cut} ${data.shape}`.toLowerCase();
        const matchKeyword = keyword.every(k => textValues.includes(k));
        if(!matchKeyword) return;

        const div = document.createElement("div");
        div.classList.add("result-item");
        div.innerHTML = `
          <div class="field"><strong>開催日</strong> <span>${data.date}</span></div>
          <div class="field"><strong>Ct</strong> <span>${data.carat}</span></div>
          <div class="field"><strong>カラー</strong> <span>${data.color}</span></div>
          <div class="field"><strong>クラリティ</strong> <span>${data.clarity}</span></div>
          <div class="field"><strong>カット</strong> <span>${data.cut}</span></div>
          <div class="field"><strong>蛍光性</strong> <span>${data.fluorescence}</span></div>
          <div class="field"><strong>形状</strong> <span>${data.shape}</span></div>
          <div class="field"><strong>備考</strong> <span>${data.note || ''}</span> <span><a href="${data.detailUrl || '#'}" target="_blank">詳細</a></span></div>
        `;
        resultDiv.appendChild(div);
      });
    }
  </script>
</body>
</html>
