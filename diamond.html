<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãƒ€ã‚¤ãƒ¤ç›¸å ´æ¤œç´¢ï¼ˆè¤‡åˆæ¡ä»¶ï¼‰</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>ãƒ€ã‚¤ãƒ¤ç›¸å ´æ¤œç´¢</h1>

  <!-- Ctå…¥åŠ›æ¬„ -->
  <label>åŸºæº– Ct:</label>
  <input type="number" id="baseCt" step="0.001" value="0.700">
  <button onclick="setCaratRange()">Ctè¨­å®š</button><br><br>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <label>æœ€å°ã‚«ãƒ©ãƒƒãƒˆ:</label>
  <input type="number" id="caratMin" step="0.01" value="0.7">
  <label>æœ€å¤§ã‚«ãƒ©ãƒƒãƒˆ:</label>
  <input type="number" id="caratMax" step="0.01" value="0.799"><br><br>

  <label>ã‚«ãƒ©ãƒ¼:</label>
  <input type="text" id="color" placeholder="ä¾‹: FANCY GREEN"><br><br>

  <label>ã‚¯ãƒ©ãƒªãƒ†ã‚£:</label>
  <input type="text" id="clarity" placeholder="ä¾‹: SI1"><br><br>

  <label>å½¢çŠ¶:</label>
  <input type="text" id="shape" placeholder="ä¾‹: RD"><br><br>

  <button onclick="search()">æ¤œç´¢</button><br><br>

  <!-- å¹³å‡å˜ä¾¡ & é‡‘é¡è¨ˆç®— -->
  <div>
    <strong>å¹³å‡å˜ä¾¡:</strong> <span id="avgPrice">-</span> å††
    &nbsp;&nbsp;
    <label>æ›ç‡:</label>
    <select id="rate" onchange="updateAmount()">
      <option value="0.5">5æ›ã‘</option>
      <option value="0.6">6æ›ã‘</option>
      <option value="0.7" selected>7æ›ã‘</option>
      <option value="0.8">8æ›ã‘</option>
      <option value="0.9">9æ›ã‘</option>
    </select>
    &nbsp;&nbsp;
    <strong>å‚è€ƒé‡‘é¡:</strong> <span id="amount">-</span> å††
  </div>

  <!-- æ¤œç´¢çµæœ -->
  <div id="result" style="margin-top:20px;"></div>

  <script>
    // ğŸ”¹ Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyAh46ZVl6ICR9ynh6G8VZn6RlApcqpSq48",
      authDomain: "sgc-diamond-db.firebaseapp.com",
      projectId: "sgc-diamond-db",
      storageBucket: "sgc-diamond-db.firebasestorage.app",
      messagingSenderId: "552067864642",
      appId: "1:552067864642:web:c4cb10821bdd7b1a85f5db",
      measurementId: "G-DNMP8JJNB7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let lastAvgPrice = 0;
    let lastBaseCt = 0;

    // ğŸ”¹ Ctã‹ã‚‰æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®æœ€å°ãƒ»æœ€å¤§ã‚«ãƒ©ãƒƒãƒˆã‚’è¨­å®š
    function setCaratRange() {
      const baseCt = parseFloat(document.getElementById("baseCt").value);
      const min = Math.floor(baseCt * 10) / 10;           // å°æ•°ç¬¬1ä½åˆ‡ã‚Šæ¨ã¦
      const max = min + 0.099;                             // æœ€å¤§å€¤ã¯ +0.099
      document.getElementById("caratMin").value = min.toFixed(3);
      document.getElementById("caratMax").value = max.toFixed(3);
      lastBaseCt = baseCt;
      updateAmount();
    }

    // ğŸ”¹ æ¤œç´¢é–¢æ•°
    async function search() {
      const caratMin = parseFloat(document.getElementById("caratMin").value);
      const caratMax = parseFloat(document.getElementById("caratMax").value);
      const color = document.getElementById("color").value.trim();
      const clarity = document.getElementById("clarity").value.trim();
      const shape = document.getElementById("shape").value.trim();

      let query = db.collection("diamonds")
        .where("carat", ">=", caratMin)
        .where("carat", "<=", caratMax);

      if(color) query = query.where("color", "==", color);
      if(clarity) query = query.where("clarity", "==", clarity);
      if(shape) query = query.where("shape", "==", shape);

      const snapshot = await query.get();
      const resultsDiv = document.getElementById("result");
      resultsDiv.innerHTML = "";

      if(snapshot.empty) {
        document.getElementById("avgPrice").innerText = "-";
        document.getElementById("amount").innerText = "-";
        resultsDiv.innerHTML = "<p>è©²å½“ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
        return;
      }

      // ğŸ”¹ å¹³å‡å˜ä¾¡è¨ˆç®—
      let sumPrice = 0;
      let count = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        sumPrice += data.pricePerCarat;
        count++;
        resultsDiv.innerHTML += `
          <div style="border-bottom:1px solid #ccc; margin:5px 0;">
            <strong>NO:</strong> ${data.NO} |
            <strong>ã‚«ãƒ©ãƒƒãƒˆ:</strong> ${data.carat} |
            <strong>ã‚«ãƒ©ãƒ¼:</strong> ${data.color} |
            <strong>ã‚¯ãƒ©ãƒªãƒ†ã‚£:</strong> ${data.clarity} |
            <strong>å½¢çŠ¶:</strong> ${data.shape} |
            <strong>å˜ä¾¡:</strong> ï¿¥${data.pricePerCarat}
          </div>
        `;
      });

      const avg = sumPrice / count;
      lastAvgPrice = avg;
      document.getElementById("avgPrice").innerText = Math.round(avg);
      updateAmount();
    }

    // ğŸ”¹ é‡‘é¡è¨ˆç®—
    function updateAmount() {
      const rate = parseFloat(document.getElementById("rate").value);
      const amountEl = document.getElementById("amount");
      if(lastAvgPrice && lastBaseCt) {
        const val = lastAvgPrice * lastBaseCt * rate;
        amountEl.innerText = Math.round(val);
      } else {
        amountEl.innerText = "-";
      }
    }

    // ğŸ”¹ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸ Ct è¨­å®š
    window.onload = setCaratRange;

  </script>
</body>
</html>
