<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ダイヤ検索結果 1.03</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: #f5f7fa;
    padding: 1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: #fff;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  th, td {
    padding: 0.6rem 0.8rem;
    text-align: center;
    border-bottom: 1px solid #eee;
    font-size: 0.95rem;
  }
  th {
    background: #00796B;
    color: #fff;
    font-weight: 600;
  }
  tr.detail-row td {
    text-align: left;
    background: #f9f9f9;
    font-size: 0.9rem;
  }
  a.detail-toggle {
    color: #00796B;
    cursor: pointer;
    text-decoration: underline;
  }
  select.rate-select {
    padding: 2px 4px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  @media (max-width: 768px) {
    th, td {
      font-size: 0.85rem;
      padding: 0.4rem 0.5rem;
    }
  }
</style>
</head>
<body>

<table id="resultTable">
  <thead>
    <tr>
      <th>日付</th>
      <th>カラー</th>
      <th>クラリティ</th>
      <th>カット</th>
      <th>蛍光性</th>
      <th>形状</th>
      <th>カラット</th>
      <th>ガイ単価</th>
      <th>掛率</th>
      <th>金額</th>
      <th>備考</th>
      <th>詳細</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyAh46ZVl6ICR9ynh6G8VZn6RlApcqpSq48",
    authDomain: "sgc-diamond-db.firebaseapp.com",
    projectId: "sgc-diamond-db",
    storageBucket: "sgc-diamond-db.firebasestorage.app",
    messagingSenderId: "552067864642",
    appId: "1:552067864642:web:c4cb10821bdd7b1a85f5db",
    measurementId: "G-DNMP8JJNB7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const resultTableBody = document.querySelector("#resultTable tbody");

  // データ取得＆表示
  db.collection("Diamonds").orderBy("開催日", "desc").get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();

      // 日付変換
      const date = data["開催日"]?.toDate ? data["開催日"].toDate() : new Date();
      const dateStr = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;

      const carat = data["石目（ct）"] || 0;
      const pricePerCarat = data["ガイ単価（円）"] || 0;
      const defaultRate = 5;
      let amount = carat * pricePerCarat * defaultRate;

      // メイン行
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>${data["カラー"] || ""}</td>
        <td>${data["クラリティ"] || ""}</td>
        <td>${data["カット（総合/P/S）"] || ""}</td>
        <td>${data["蛍光性"] || ""}</td>
        <td>${data["形状"] || ""}</td>
        <td>${carat.toFixed(3)}</td>
        <td>${pricePerCarat.toLocaleString()}</td>
        <td>
          <select class="rate-select">
            <option value="5" selected>5倍</option>
            <option value="6">6倍</option>
            <option value="7">7倍</option>
            <option value="8">8倍</option>
            <option value="9">9倍</option>
          </select>
        </td>
        <td class="amount-cell">${amount.toLocaleString()}</td>
        <td>${data["備考"] || ""}</td>
        <td><a class="detail-toggle">表示</a></td>
      `;
      resultTableBody.appendChild(tr);

      // 詳細行
      const detailTr = document.createElement("tr");
      detailTr.classList.add("detail-row");
      detailTr.style.display = "none";
      detailTr.innerHTML = `
        <td colspan="12">
          直径: ${data["直径（最小）（mm）"] || ""} ～ ${data["直径（最大）（mm）"] || ""} mm、
          高さ: ${data["高さ（mm）"] || ""} mm、
          不正円率: ${data["不正円率"] || ""}、
          全高比: ${data["全高比（％）"] || ""} %
        </td>
      `;
      resultTableBody.appendChild(detailTr);

      // 詳細リンククリックで展開
      tr.querySelector(".detail-toggle").addEventListener("click", () => {
        if(detailTr.style.display === "none") {
          detailTr.style.display = "table-row";
          tr.querySelector(".detail-toggle").textContent = "非表示";
        } else {
          detailTr.style.display = "none";
          tr.querySelector(".detail-toggle").textContent = "表示";
        }
      });

      // 掛率変更時に金額更新
      const rateSelect = tr.querySelector(".rate-select");
      const amountCell = tr.querySelector(".amount-cell");
      rateSelect.addEventListener("change", () => {
        const rate = parseFloat(rateSelect.value);
        const newAmount = carat * pricePerCarat * rate;
        amountCell.textContent = newAmount.toLocaleString();
      });
    });
  }).catch(err => {
    console.error(err);
    alert("データ取得に失敗しました。");
  });
</script>

</body>
</html>
