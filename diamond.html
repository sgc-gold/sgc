<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SGC ダイヤ検索　1.13</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* =======================
   基本スタイル
======================= */
body {
  margin:0; padding:0; font-family:'Noto Sans JP', sans-serif; background:#f5f7fa;
}
.container { max-width:900px; margin:1.5rem auto; background:#fff; border-radius:16px; padding:1.8rem; box-shadow:0 4px 14px rgba(0,0,0,0.08);}
h2 { margin-bottom:1rem; color:#004d40; }
input, select, button { font-size:1rem; padding:0.5rem 0.75rem; border-radius:8px; border:1px solid #ccc; }
input:focus, select:focus { outline:none; border-color:#bfa14a; box-shadow:0 0 0 2px rgba(191,161,74,0.2);}
button { cursor:pointer; transition:all 0.2s ease;}
#searchButton { background:linear-gradient(135deg,#bfa14a,#d4b95e); color:#fff; font-weight:600;}
#searchButton:hover { opacity:0.9; transform:translateY(-1px);}
#clearButton { background:#e0e0e0; color:#333;}
#clearButton:hover { background:#ccc;}
.flex-row { display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center; margin-bottom:0.8rem;}
.flex-row label { width:150px; font-weight:600; text-align:center;}
.flex-row input[type="text"], .flex-row select { flex:1; min-width:120px;}
#caratRange { display:flex; align-items:center; gap:0.5rem;}
#caratRange input { width:80px; text-align:center;}
#caratRange span { font-weight:600; }
#caratSetRow {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  flex-wrap: wrap;
}

#caratRange {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#caratRange input {
  width: 80px;
  text-align: center;
}

/* =======================
   テーブルスタイル
======================= */
#resultTable { width:100%; border-collapse:collapse; margin-top:1rem; }
#resultTable th, #resultTable td { border:1px solid #ddd; padding:6px 0px; text-align:center; font-size:0.65rem;}
#resultTable th { background:#f0f0f0; font-weight:600; color:#333;}
.detailsRow { display:none; background:#fafafa; }
.detailsRow td { text-align:left; font-size:0.9rem; }
.detailToggle { color:#00796B; cursor:pointer; font-weight:600; }
@media(max-width:480px){
  .flex-row { flex-direction:column; align-items:flex-start;}
  .flex-row label { width:100%; text-align:center; margin-bottom:0.2rem;}
  #caratRange { flex-direction:column; align-items:flex-start;}
}
</style>
</head>
<body>
<div class="container">
  <h2>ダイヤ検索フォーム</h2>

  <!-- カラットセット + 最小～最大 -->
  <div class="flex-row">
  <label for="mainCarat">カラット（ct）</label>
  <div id="caratSetRow">
    <input type="text" id="mainCarat" placeholder="例：0.345">
    <button type="button" id="setCarat">セット</button>

    <!-- 最小～最大カラット -->
    <div id="caratRange">
      <input type="text" id="minCarat" placeholder="最小ct">
      <span>～</span>
      <input type="text" id="maxCarat" placeholder="最大ct">
    </div>
  </div>
  </div>

  <!-- 検索フォーム -->
  <div class="flex-row">
    <label for="dateSelect">開催日</label>
    <select id="dateSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="colorSelect">カラー</label>
    <select id="colorSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="claritySelect">クラリティ</label>
    <select id="claritySelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="cutSelect">カット</label>
    <select id="cutSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="fluorescenceSelect">蛍光性</label>
    <select id="fluorescenceSelect"><option value="">すべて</option></select>
  </div>
  <div class="flex-row">
    <label for="shapeSelect">形状</label>
    <select id="shapeSelect"><option value="">すべて</option></select>
  </div>

  <!-- フリーワード -->
  <div class="flex-row">
    <label for="keyword">フリーワード</label>
    <input type="text" id="keyword" placeholder="例：D VS1 GD">
  </div>

  <div class="flex-row" style="justify-content:center; gap:1rem;">
    <button id="searchButton">検索</button>
    <button id="clearButton">クリア</button>
  </div>

  <!-- 結果テーブル -->
  <table id="resultTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>カラー</th>
        <th>クラリティ</th>
        <th>カット</th>
        <th>蛍光性</th>
        <th>形状</th>
        <th>カラット</th>
        <th>ガイ単価</th>
        <th>金額</th>
        <th>備考</th>
        <th>詳細</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>
</div>

<script>
// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyAh46ZVl6ICR9ynh6G8VZn6RlApcqpSq48",
  authDomain: "sgc-diamond-db.firebaseapp.com",
  projectId: "sgc-diamond-db",
  storageBucket: "sgc-diamond-db.firebasestorage.app",
  messagingSenderId: "552067864642",
  appId: "1:552067864642:web:c4cb10821bdd7b1a85f5db",
  measurementId: "G-DNMP8JJNB7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------------
// カラットセット機能
// ---------------------
document.getElementById("setCarat").addEventListener("click", ()=>{
  let c = parseFloat(document.getElementById("mainCarat").value);
  if(isNaN(c)) return alert("数値を入力してください");
  let min = Math.floor(c*10)/10;
  let max = min+0.099;
  document.getElementById("minCarat").value = min.toFixed(3);
  document.getElementById("maxCarat").value = max.toFixed(3);
});

// ---------------------
// 開催日・カラー等の選択肢自動取得
// ---------------------
async function populateFilters(){
  const snapshot = await db.collection("diamonds").get();
  const dates=new Set(), colors=new Set(), clarities=new Set(), cuts=new Set(), fluo=new Set(), shapes=new Set();
  snapshot.forEach(doc=>{
    const d = doc.data();
    dates.add(d.date?.toDate().toLocaleDateString("ja-JP"));
    if(d.color) colors.add(d.color);
    if(d.clarity) clarities.add(d.clarity);
    if(d.cut) cuts.add(d.cut);
    if(d.fluorescence) fluo.add(d.fluorescence);
    if(d.shape) shapes.add(d.shape);
  });
  const addOption=(sel, val)=>{ sel.appendChild(new Option(val,val)); };
  const dateSelect=document.getElementById("dateSelect");
  Array.from(dates).sort().forEach(d=>addOption(dateSelect,d));
  Array.from(colors).sort().forEach(c=>addOption(document.getElementById("colorSelect"),c));
  Array.from(clarities).sort().forEach(c=>addOption(document.getElementById("claritySelect"),c));
  Array.from(cuts).sort().forEach(c=>addOption(document.getElementById("cutSelect"),c));
  Array.from(fluo).sort().forEach(f=>addOption(document.getElementById("fluorescenceSelect"),f));
  Array.from(shapes).sort().forEach(s=>addOption(document.getElementById("shapeSelect"),s));
}
populateFilters();

// ---------------------
// 検索処理
// ---------------------
document.getElementById("searchButton").addEventListener("click", async ()=>{
  const minC=parseFloat(document.getElementById("minCarat").value)||0;
  const maxC=parseFloat(document.getElementById("maxCarat").value)||999;
  const dateVal=document.getElementById("dateSelect").value;
  const colorVal=document.getElementById("colorSelect").value;
  const clarityVal=document.getElementById("claritySelect").value;
  const cutVal=document.getElementById("cutSelect").value;
  const fluVal=document.getElementById("fluorescenceSelect").value;
  const shapeVal=document.getElementById("shapeSelect").value;
  const keyword=document.getElementById("keyword").value.trim().toLowerCase();

  const snapshot = await db.collection("Diamonds").get();
  const tbody=document.getElementById("resultBody");
  tbody.innerHTML="";

  snapshot.forEach(doc=>{
    const d=doc.data();
    const c=d.carat;
    if(c<minC || c>maxC) return;
    if(dateVal && d.date?.toDate().toLocaleDateString("ja-JP")!=dateVal) return;
    if(colorVal && d.color!=colorVal) return;
    if(clarityVal && d.clarity!=clarityVal) return;
    if(cutVal && d.cut!=cutVal) return;
    if(fluVal && d.fluorescence!=fluVal) return;
    if(shapeVal && d.shape!=shapeVal) return;
    // キーワード検索
    if(keyword){
      const fields=[d.color,d.clarity,d.cut,d.shape,d.notes].join(" ").toLowerCase();
      const kws=keyword.split(" ");
      if(!kws.every(k=>fields.includes(k))) return;
    }

    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${d.date?.toDate().toLocaleDateString("ja-JP")||""}</td>
      <td>${d.color||""}</td>
      <td>${d.clarity||""}</td>
      <td>${d.cut||""}</td>
      <td>${d.fluorescence||""}</td>
      <td>${d.shape||""}</td>
      <td>${d.carat?.toFixed(3)||""}</td>
      <td>${d.pricePerCarat?.toLocaleString()||""}</td>
      <td>${(d.pricePerCarat*d.carat)?.toLocaleString()||""}</td>
      <td>${d.notes||""}</td>
      <td><span class="detailToggle">詳細</span></td>
    `;
    tbody.appendChild(row);

    // 詳細行
    const detailRow = document.createElement("tr");
    detailRow.classList.add("detailsRow");
   
    // 🔸 不正円率・全高比の数値を変換
    const unevenRate = d.unevenRate ? (parseFloat(d.unevenRate) * 100).toFixed(2) : "";
    const heightRatio = d.heightRatio ? (parseFloat(d.heightRatio) * 100).toFixed(2) + "%" : "";
   
    detailRow.innerHTML = `
      <td colspan="11">
        直径（最小）: ${d.diameterMin || ""}mm ー（最大）: ${d.diameterMax || ""}mm ※ 高さ: ${d.height || ""}mm<br>
        不正円率: ${unevenRate}　　全高比: ${heightRatio}
      </td>
    `;
    tbody.appendChild(detailRow);

    row.querySelector(".detailToggle").addEventListener("click", ()=>{
      detailRow.style.display = detailRow.style.display==="table-row"?"none":"table-row";
    });
  });
});

// ---------------------
// クリアボタン
// ---------------------
document.getElementById("clearButton").addEventListener("click", ()=>{
  document.getElementById("minCarat").value="";
  document.getElementById("maxCarat").value="";
  document.getElementById("mainCarat").value="";
  document.getElementById("dateSelect").value="";
  document.getElementById("colorSelect").value="";
  document.getElementById("claritySelect").value="";
  document.getElementById("cutSelect").value="";
  document.getElementById("fluorescenceSelect").value="";
  document.getElementById("shapeSelect").value="";
  document.getElementById("keyword").value="";
  document.getElementById("resultBody").innerHTML="";
});
</script>
</body>
</html>
