<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ€ã‚¤ãƒ¤ç›¸å ´æ¤œç´¢ 1.32</title>
<style>
/* =======================
   åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
======================= */
body {
  margin:0; padding:0; font-family:'Noto Sans JP', sans-serif; background:#f5f7fa;
}
.container { max-width:900px; margin:1.5rem auto; background:#fff; border-radius:16px; padding:1.8rem; box-shadow:0 4px 14px rgba(0,0,0,0.08);}
h2 { margin-bottom:1rem; color:#004d40; }
input, select, button { font-size:1rem; padding:0.5rem 0.75rem; border-radius:8px; border:1px solid #ccc; }
input:focus, select:focus { outline:none; border-color:#bfa14a; box-shadow:0 0 0 2px rgba(191,161,74,0.2);}
button { cursor:pointer; transition:all 0.2s ease;}
#searchButton { background:linear-gradient(135deg,#bfa14a,#d4b95e); color:#fff; font-weight:600;}
#searchButton:hover { opacity:0.9; transform:translateY(-1px);}
#clearButton { background:#e0e0e0; color:#333;}
#clearButton:hover { background:#ccc;}
.flex-row { display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center; margin-bottom:0.8rem;}
.flex-row label { width:150px; font-weight:600; text-align:center;}
.flex-row input[type="text"], .flex-row select { flex:1; /*min-width:120px;*/}

/* ã‚«ãƒ©ãƒƒãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
#mainCarat {
  width: 90px;  /* å¹…ã‚’ç‹­ãã—ã¦ X.XXX ãŒåã¾ã‚‹ã‚µã‚¤ã‚ºã« */
  text-align: center;
}
   
/* ã‚«ãƒ©ãƒƒãƒˆã‚»ãƒƒãƒˆ + æœ€å°ï½æœ€å¤§ã‚«ãƒƒãƒˆã®é…ç½® */
#caratSetRow {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

#caratSetRow button#setCarat {
  margin-right: 3rem;
  margin-left: 1rem;  
}
   
/* æœ€å°ï½æœ€å¤§ã‚«ãƒ©ãƒƒãƒˆå…¥åŠ›ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#caratRange {
  display: inline-flex; /* ğŸ”¸ flexæ–¹å‘ã¯ãã®ã¾ã¾ */
  align-items: center;
  gap: 0.6rem; /* ğŸ”¸ æœ€å°ctã¨æœ€å¤§ctã®é–“éš” */
}

#caratRange input {
  width: 90px;
  text-align: center;
  border-radius: 0;      /* ğŸ”¸ å››è§’ã„æ ã« */
  border: 1px solid #ccc;
  padding: 0.45rem 0.6rem;
  transition: all 0.2s ease;
}

#caratRange input:focus {
  border-color: #bfa14a;
  box-shadow: 0 0 0 2px rgba(191,161,74,0.15);
  outline: none;
}

#caratRange span {
  font-weight: 600;
}

/* =======================
   ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
======================= */
#resultTable { width:100%; border-collapse:collapse; margin-top:1rem; }
#resultTable th, #resultTable td { border:1px solid #ddd; padding:6px 0px; text-align:center; font-size:0.65rem;}
#resultTable th { background:#f0f0f0; font-weight:600; color:#333;}
.detailsRow { display:none; background:#fafafa; }
.detailsRow td { text-align:left; font-size:0.9rem; }
.detailToggle { color:#00796B; cursor:pointer; font-weight:600; }

/* =======================
   ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼
======================= */
.spinner {
  width: 32px;
  height: 32px;
  border: 4px solid #ccc;
  border-top: 4px solid #bfa14a;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
   
/* ä»¶æ•°è¡¨ç¤ºï¼ˆä¸Šãƒ»ä¸‹ï¼‰ */
.stylish-count {
  font-size: 1.05rem;
  font-weight: 600;
  color: #333;
  background: transparent;
  border: none;
  padding: 4px 0 8px 4px;
  display: inline-block;
  margin: 6px 0 12px 2px;
  letter-spacing: 0.3px;
  position: relative;
}

.stylish-count::before {
  content: "";
  position: absolute;
  left: 0;
  bottom: 0;
  width: 80px;
  height: 2px;
  background: linear-gradient(90deg, #bfa14a, transparent);
  border-radius: 2px;
}

/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
.stylish-pagination {
  margin: 22px 0 8px;
  text-align: center;
}

.stylish-pagination button {
  background: transparent;
  color: #333;
  border: 1px solid #ccc;
  padding: 6px 12px;
  margin: 0 4px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.25s ease;
}

.stylish-pagination button:hover:not(:disabled) {
  background: linear-gradient(135deg, #f9f7ed, #fff);
  border-color: #bfa14a;
  color: #bfa14a;
  transform: translateY(-1px);
}

.stylish-pagination button:disabled {
  color: #aaa;
  border-color: #eee;
  cursor: not-allowed;
}

.stylish-pagination span {
  font-size: 0.95rem;
  color: #555;
  margin: 0 10px;
}
   
@media(max-width:480px){
  .flex-row { flex-direction:column; align-items:flex-start;}
  .flex-row label { width:100%; text-align:center; margin-bottom:0.2rem;}
  #caratRange { flex-direction:column; align-items:flex-start;}
}
</style>
</head>
<body>
<div class="container">
  <h2>ãƒ€ã‚¤ãƒ¤æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ </h2>

  <!-- ã“ã“ã‚‚å…ƒã‚³ãƒ¼ãƒ‰ã¨åŒã˜ HTML -->
  <!-- ã‚«ãƒ©ãƒƒãƒˆã‚»ãƒƒãƒˆ + æœ€å°ï½æœ€å¤§ -->
  <div class="flex-row">
    <label for="mainCarat">ã‚«ãƒ©ãƒƒãƒˆï¼ˆctï¼‰</label>
    <div id="caratSetRow">
      <input type="text" id="mainCarat" placeholder="ä¾‹ï¼š0.345">
      <button type="button" id="setCarat">ã‚»ãƒƒãƒˆ</button>
      <div id="caratRange">
        <input type="text" id="minCarat" placeholder="æœ€å°ct">
        <span>ï½</span>
        <input type="text" id="maxCarat" placeholder="æœ€å¤§ct">
      </div>
    </div>
  </div>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰ -->
  <div class="flex-row" style="align-items:center;">
    <label for="dateSelect">é–‹å‚¬æ—¥</label>
    <select id="dateSelect"><option value="">ã™ã¹ã¦</option></select>
    <span style="margin-left:0.5rem; color:#555; font-size:0.9rem;">â€»é¸æŠæ—¥ä»¥é™ã§æ¤œç´¢</span>
  </div>

   <!-- ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚«ãƒ©ãƒ¼ç¯„å›² -->
   <div class="flex-row">
     <label>ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚«ãƒ©ãƒ¼</label>
     <select id="fromColor"><option value="">From</option></select>
     <span>ã€œ</span>
     <select id="toColor"><option value="">To</option></select>
   </div>
   
   <!-- FANCYç³»ã‚«ãƒ©ãƒ¼ -->
   <div class="flex-row" style="gap: 1rem; align-items: center;">
     <div>
       <label>FANCYã‚°ãƒ¬ãƒ¼ãƒ‰</label>
       <select id="fancyGradeSelect"><option value="">ã™ã¹ã¦</option></select>
     </div>
     <div>
       <label>FANCYè‰²å‘³</label>
       <select id="fancyToneSelect"><option value="">ã™ã¹ã¦</option></select>
     </div>
   </div>   
   
  <div class="flex-row">
    <label for="claritySelect">ã‚¯ãƒ©ãƒªãƒ†ã‚£</label>
    <select id="claritySelect"><option value="">ã™ã¹ã¦</option></select>
  </div>
  <div class="flex-row">
    <label for="cutSelect">ã‚«ãƒƒãƒˆ</label>
    <select id="cutSelect"><option value="">ã™ã¹ã¦</option></select>
  </div>
  <div class="flex-row">
    <label for="fluorescenceSelect">è›å…‰æ€§</label>
    <select id="fluorescenceSelect"><option value="">ã™ã¹ã¦</option></select>
  </div>
  <div class="flex-row">
    <label for="shapeSelect">å½¢çŠ¶</label>
    <select id="shapeSelect"><option value="">ã™ã¹ã¦</option></select>
  </div>

  <div class="flex-row">
    <label for="keyword">ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
    <input type="text" id="keyword" placeholder="ä¾‹ï¼šD VS1 GD">
  </div>

  <div class="flex-row" style="justify-content:center; gap:1rem;">
    <button id="searchButton">æ¤œç´¢</button>
    <button id="clearButton">ã‚¯ãƒªã‚¢</button>
  </div>

 <div id="loadingSpinner" style="display:none; justify-content:center; margin-top:1rem;">
   <div class="spinner"></div>
 </div>

  <!-- çµæœãƒ†ãƒ¼ãƒ–ãƒ« -->
  <table id="resultTable">
    <thead>
      <tr>
        <th>æ—¥ä»˜</th>
        <th>ã‚«ãƒ©ãƒ¼</th>
        <th>ã‚¯ãƒ©ãƒªãƒ†ã‚£</th>
        <th>ã‚«ãƒƒãƒˆ</th>
        <th>è›å…‰æ€§</th>
        <th>å½¢çŠ¶</th>
        <th>ã‚«ãƒ©ãƒƒãƒˆ</th>
        <th>ã‚¬ã‚¤å˜ä¾¡</th>
        <th>é‡‘é¡</th>
        <th>å‚™è€ƒ</th>
        <th>è©³ç´°</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>
</div>

<script>
  // ---------------------
  // ã‚«ãƒ©ãƒƒãƒˆã‚»ãƒƒãƒˆæ©Ÿèƒ½
  // ---------------------
  document.getElementById("setCarat").addEventListener("click", () => {
    let c = parseFloat(document.getElementById("mainCarat").value);
    if (isNaN(c)) return alert("æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    let min = Math.floor(c * 10) / 10;
    let max = min + 0.099;

    document.getElementById("minCarat").value = min.toFixed(3);
    document.getElementById("maxCarat").value = max.toFixed(3);
  });

  // ---------------------
  // JSON å–å¾— & ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠè‚¢ä½œæˆ
  // ---------------------
  let diamondData = [];

  async function populateFilters() {
    const url = "https://raw.githubusercontent.com/sgc-gold/sgc/main/data/diamonds.json";
    const resp = await fetch(url);
    diamondData = await resp.json();

    const dates = new Set(),
          colors = new Set(),
          clarities = new Set(),
          cuts = new Set(),
          fluo = new Set(),
          shapes = new Set();

    diamondData.forEach(d => {
      if (d.date) dates.add(d.date.split(" ")[0]);
      if (d.color) colors.add(d.color);
      if (d.clarity) clarities.add(d.clarity);
      if (d.cut) cuts.add(d.cut);
      if (d.fluorescence) fluo.add(d.fluorescence);
      if (d.shape) shapes.add(d.shape);
    });

    const addOption = (sel, val) => sel.appendChild(new Option(val, val));

    Array.from(dates)
      .sort((a, b) => new Date(b) - new Date(a))
      .forEach(d => addOption(document.getElementById("dateSelect"), d));
    document.getElementById("dateSelect").selectedIndex = 1;

    Array.from(clarities).sort().forEach(c => addOption(document.getElementById("claritySelect"), c));
    Array.from(cuts).sort().forEach(c => addOption(document.getElementById("cutSelect"), c));
    Array.from(fluo).sort().forEach(f => addOption(document.getElementById("fluorescenceSelect"), f));
    Array.from(shapes).sort().forEach(s => addOption(document.getElementById("shapeSelect"), s));

    // ğŸ”¹ã€è¿½åŠ â‘ ã€‘ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚«ãƒ©ãƒ¼é¸æŠè‚¢ã®ç”Ÿæˆ
    const alphabetColors = [
      "D","E","F","G","H","I","J","K","L","M","N","O","P",
      "Q","R","S","T","U","V","W","X","Y","Z"
    ];
    const fromColorSel = document.getElementById("fromColor");
    const toColorSel = document.getElementById("toColor");
    alphabetColors.forEach(c => {
      addOption(fromColorSel, c);
      addOption(toColorSel, c);
    });

    // ğŸ”¹ã€è¿½åŠ â‘¡ã€‘FANCYã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ»ãƒˆãƒ¼ãƒ³ã®é¸æŠè‚¢ç”Ÿæˆ
    const fancyGrades = [
      "FAINT", "VERY LIGHT", "LIGHT", "FANCY LIGHT", "FANCY",
      "FANCY INTENSE", "FANCY VIVID", "FANCY DEEP", "FANCY DARK"
    ];
    const fancyTones = [
      "YELLOW", "PINK", "BLUE", "GREEN", "BROWN", "ORANGE",
      "PURPLE", "RED", "GRAY", "BLACK"
    ];

    const fancyGradeSel = document.getElementById("fancyGradeSelect");
    const fancyToneSel = document.getElementById("fancyToneSelect");
    fancyGrades.forEach(g => addOption(fancyGradeSel, g));
    fancyTones.forEach(t => addOption(fancyToneSel, t));
  }

  populateFilters();

  // ---------------------
  // FANCYã‚«ãƒ©ãƒ¼åˆ¤å®šé–¢æ•°
  // ---------------------
  function isFancyColor(color) {
    if (!color) return false;
    const upper = color.toUpperCase();
    return /(FANCY|FAINT|LIGHT|INTENSE|VIVID|DEEP|DARK)/.test(upper);
  }

  // ---------------------
  // æ¤œç´¢å‡¦ç†ï¼ˆä»¶æ•°è¡¨ç¤ºï¼‹ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  // ---------------------
  document.getElementById("searchButton").addEventListener("click", () => {
    const spinner = document.getElementById("loadingSpinner");
    spinner.style.display = "flex";

    setTimeout(() => {
      // ğŸ”¹ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤å–å¾—
      const minC = parseFloat(document.getElementById("minCarat").value) || 0;
      const maxC = parseFloat(document.getElementById("maxCarat").value) || 999;
      const dateVal = document.getElementById("dateSelect").value;
      const clarityVal = document.getElementById("claritySelect").value;
      const cutVal = document.getElementById("cutSelect").value;
      const fluVal = document.getElementById("fluorescenceSelect").value;
      const shapeVal = document.getElementById("shapeSelect").value;
      const keyword = document.getElementById("keyword").value.trim().toLowerCase();

      // ğŸ”¹ ã‚«ãƒ©ãƒ¼æ¤œç´¢ç”¨ã®è¿½åŠ é …ç›®
      const fromColor = document.getElementById("fromColor").value;
      const toColor = document.getElementById("toColor").value;
      const fancyGrade = document.getElementById("fancyGradeSelect").value;
      const fancyTone = document.getElementById("fancyToneSelect").value;
       
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = "";

      // ä»¶æ•°è¡¨ç¤ºã‚¨ãƒªã‚¢
      let countTop = document.getElementById("resultCountTop");
      let countBottom = document.getElementById("resultCountBottom");

      if (!countTop) {
        countTop = document.createElement("div");
        countTop.id = "resultCountTop";
        countTop.className = "result-count stylish-count";
        tbody.parentElement.insertAdjacentElement("beforebegin", countTop);
      }
      if (!countBottom) {
        countBottom = document.createElement("div");
        countBottom.id = "resultCountBottom";
        countBottom.className = "result-count stylish-count";
        tbody.parentElement.insertAdjacentElement("afterend", countBottom);
      }

      // ğŸ”¹ ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚«ãƒ©ãƒ¼ç¯„å›²
      const alphabetColors = ["D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
      const fromIndex = alphabetColors.indexOf(fromColor);
      const toIndex = alphabetColors.indexOf(toColor);
       
      // çµã‚Šè¾¼ã¿
      const results = diamondData.filter(d => {
        const c = parseFloat(d.carat) || 0;
        if (c < minC || c > maxC) return false;
        if (dateVal && d.date.split(" ")[0] < dateVal) return false;
        if (clarityVal && d.clarity != clarityVal) return false;
        if (cutVal && d.cut != cutVal) return false;
        if (fluVal && d.fluorescence != fluVal) return false;
        if (shapeVal && d.shape != shapeVal) return false;
        // ğŸ”¹ ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰
        if (keyword) {
          const fields = [d.color, d.clarity, d.cut, d.shape, d.notes].join(" ").toLowerCase();
          if (!keyword.split(" ").every(k => fields.includes(k))) return false;
        }

        // ğŸ”¹ ã‚«ãƒ©ãƒ¼æ¤œç´¢æ¡ä»¶
        const colorUpper = (d.color || "").toUpperCase();
      
        // --- â‘  ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚«ãƒ©ãƒ¼ç¯„å›²ï¼ˆDã€œZï¼‰
        let matchAlphabet = false;
        if (fromColor && toColor) {
          const colorIndex = alphabetColors.findIndex(c => colorUpper.startsWith(c));
          if (colorIndex !== -1) matchAlphabet = (colorIndex >= fromIndex && colorIndex <= toIndex);
        }
      
        // --- â‘¡ FANCYã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‹ãƒˆãƒ¼ãƒ³æ¤œç´¢ï¼ˆANDæ¤œç´¢ï¼‰
        let matchFancy = false;
        if (fancyGrade || fancyTone) {
          const matchGrade = fancyGrade ? colorUpper.includes(fancyGrade.toUpperCase()) : true;
          const matchTone  = fancyTone  ? colorUpper.includes(fancyTone.toUpperCase()) : true;
          matchFancy = matchGrade && matchTone;
        }
      
        // --- â‘ ã¨â‘¡ã‚’ORæ¤œç´¢ã§çµ±åˆ
        let colorMatch = matchAlphabet || matchFancy;
      
        // --- æ¡ä»¶ä¸ä¸€è‡´ãªã‚‰é™¤å¤–
        if (!colorMatch) return false;
                
        return true;
      });

      // ---------------------
      // ã‚«ãƒ©ãƒ¼ãƒ»ã‚«ãƒƒãƒˆãƒ»è›å…‰æ€§ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°
      // ---------------------
      function getColorScore(color) {
        const baseMap = {
          D: 100, E: 95, F: 90, G: 85, H: 80, I: 75, J: 70, K: 65, L: 60, M: 55,
          N: 50, O: 45, P: 40, Q: 35, R: 30, S: 25, T: 20, U: 15, V: 10, W: 5, X: 3, Y: 2, Z: 1
        };
        const fancyGradeMap = {
          "FANCY VIVID": 20, "FANCY INTENSE": 18, "FANCY DEEP": 16,
          "FANCY DARK": 14, "FANCY": 12, "FANCY LIGHT": 10, "LIGHT": 8, "VERY LIGHT": 6, "FAINT": 4
        };
        const fancyColorMap = {
          RED: 30, BLUE: 25, PINK: 20, GREEN: 18, ORANGE: 15, PURPLE: 12, VIOLET: 10,
          YELLOW: 8, BROWN: 5, GRAY: 3, BLACK: 2, WHITE: 1
        };
        const ishMap = {
          PINKISH: 1, PURPLISH: 1, BLUISH: 0, GREENISH: 0,
          BROWNISH: -2, GRAYISH: -3, YELLOWISH: -1,
          ORANGY: -1, VIOLETISH: 0, BLACKISH: -3
        };

        const upperColor = color.toUpperCase().trim();
        let score = 0;

        const rangeMatch = upperColor.match(/([A-Z])\s*[-TO]+\s*([A-Z])/);
        if (rangeMatch) {
          const start = baseMap[rangeMatch[1]] || 0;
          const end = baseMap[rangeMatch[2]] || 0;
          score = (start + end) / 2;
        } else {
          for (const key in baseMap) {
            if (upperColor.startsWith(key) || upperColor.includes("UNDER " + key)) {
              score = baseMap[key];
              break;
            }
          }
        }

        if (upperColor.includes("UNDER N")) score += 2000;
        else if (upperColor.includes("UNDER S")) score += 1000;
        else if (/^[D-Z]/.test(upperColor)) score += 3000;

        if (upperColor.includes("TREATED")) score -= 0.1;
        if (upperColor.includes("FAINT") || upperColor.includes("LIGHT BROWN")) score -= 1;

        if (score < 1) {
          for (const grade in fancyGradeMap) if (upperColor.includes(grade)) score += fancyGradeMap[grade];
          for (const tone in fancyColorMap) if (upperColor.includes(tone)) score += fancyColorMap[tone];
          for (const ish in ishMap) if (upperColor.includes(ish)) score += ishMap[ish];
          score += 1000; // FANCYè£œåŠ©ã‚¹ã‚³ã‚¢
        }

        return score;
      }

      function getCutScore(cutStr) {
        const rankMap = { "3EX": 100, EX: 90, VG: 70, GD: 50, FR: 30, FA: 29, PR: 10, PO: 9 };
        let score = 0;

        if (cutStr.includes("H&C") || cutStr.includes("HC")) score += 5;
        if (cutStr.includes("HEART") || cutStr.includes("H&A")) score += 3;

        const parts = cutStr.split("/");
        const main = parts[0].replace(/[^A-Z]/g, "");
        score += rankMap[main] || 0;

        if (parts.length === 3) {
          score += (rankMap[parts[2]] || 0) * 0.1;
          score += (rankMap[parts[1]] || 0) * 0.05;
        } else if (parts.length === 2) {
          score += (rankMap[parts[1]] || 0) * 0.05;
        }

        return score;
      }

      function getFluorescenceScore(fluo) {
        const intensityMap = { N: 0, NONE: 0, F: 1, FAINT: 1, M: 2, MEDIUM: 2, S: 3, STRONG: 3, VS: 4, "VERY STRONG": 4 };
        const colorBonusMap = {
          BLUE: 0.5, BL: 0.5, FB: 0.5, MB: 0.5, VSB: 0.5,
          YELLOW: -0.5, FtY: -0.5, MY: -0.5, SY: -0.5, VSY: -0.5,
          GREEN: 0, FtYGn: 0, MYGn: 0, SYGn: 0, VSYGn: 0,
          WHITE: 0, WB: 0, MBW: 0, VSBW: 0,
          GRAY: -1, SWG: -1, WYG: -1,
          INERT: 0
        };

        const upper = fluo.toUpperCase();
        let score = 0;

        for (const key in intensityMap) if (upper.includes(key)) { score += intensityMap[key]; break; }
        for (const key in colorBonusMap) if (upper.includes(key)) { score += colorBonusMap[key]; break; }

        return score;
      }

      // ---------------------
      // ä¸¦ã³é †ã‚½ãƒ¼ãƒˆ
      // ---------------------
      const CLARITY_ORDER = ["FL", "IF", "VVS1", "VVS2", "VS1", "VS2", "SI1", "SI2", "I1", "I2", "I3"];
      const caratThresholds = [0, 0.1, 0.2, 0.25, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.5, 2, 3, 5];

      function isFancyColor(color) {
        const upper = color.toUpperCase();
        if (upper.includes("UNDER")) return false;
        const fancyGrades = ["FANCY", "LIGHT", "VERY LIGHT", "FAINT"];
        const fancyTones = ["PINK", "PURPLE", "BLUE", "GREEN", "ORANGE", "YELLOW", "BROWN", "GRAY", "RED", "VIOLET", "BLACK", "WHITE"];
        const ishTerms = ["ISH", "ORANGY", "PINKISH", "PURPLISH", "GRAYISH", "YELLOWISH", "BROWNISH", "GREENISH", "BLUISH"];
        return fancyGrades.some(g => upper.includes(g)) || fancyTones.some(t => upper.includes(t)) || ishTerms.some(i => upper.includes(i));
      }

      function getCaratGroupIndex(carat, color) {
        const maxIndex = caratThresholds.length;
        if (isFancyColor(color)) return maxIndex;
        for (let i = 0; i < caratThresholds.length; i++) {
          if (carat < caratThresholds[i]) return i;
        }
        return maxIndex - 1;
      }

      results.sort((a, b) => {
        const groupA = getCaratGroupIndex(a.carat, a.color);
        const groupB = getCaratGroupIndex(b.carat, b.color);
        if (groupA !== groupB) return groupA - groupB;
        const colorScoreDiff = getColorScore(b.color) - getColorScore(a.color);
        if (colorScoreDiff !== 0) return colorScoreDiff;
        const clarityDiff = CLARITY_ORDER.indexOf(a.clarity) - CLARITY_ORDER.indexOf(b.clarity);
        if (clarityDiff !== 0) return clarityDiff;
        const cutScoreDiff = getCutScore(b.cut) - getCutScore(a.cut);
        if (cutScoreDiff !== 0) return cutScoreDiff;
        return getFluorescenceScore(b.fluorescence) - getFluorescenceScore(a.fluorescence);
      });

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ»è¡¨ç¤ºå‡¦ç†
      const perPage = 100;
      let currentPage = 1;
      const totalPages = Math.ceil(results.length / perPage);

      function renderPage(page) {
        tbody.innerHTML = "";
        const start = (page - 1) * perPage;
        const end = start + perPage;
        results.slice(start, end).forEach(d => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${d.date.split(" ")[0] || ""}</td>
            <td>${d.color || ""}</td>
            <td>${d.clarity || ""}</td>
            <td>${d.cut || ""}</td>
            <td>${d.fluorescence || ""}</td>
            <td>${d.shape || ""}</td>
            <td>${parseFloat(d.carat)?.toFixed(3) || ""}</td>
            <td>${parseFloat(d.pricePerCarat)?.toLocaleString() || ""}</td>
            <td>${(parseFloat(d.pricePerCarat) * parseFloat(d.carat))?.toLocaleString() || ""}</td>
            <td>${d.notes || ""}</td>
            <td><span class="detailToggle">è©³ç´°</span></td>
          `;
          tbody.appendChild(row);

          const detailRow = document.createElement("tr");
          detailRow.classList.add("detailsRow");

          let unevenRate = "", heightRatio = "";
          if (d.diameterMin && d.diameterMax) {
            const min = parseFloat(d.diameterMin), max = parseFloat(d.diameterMax);
            const avg = (min + max) / 2;
            unevenRate = (((max - min) / avg) * 100).toFixed(2) + "%";
            if (d.height) heightRatio = ((parseFloat(d.height) / avg) * 100).toFixed(2) + "%";
          }

          detailRow.innerHTML = `
            <td colspan="11">
              ç›´å¾„ï¼š${d.diameterMin || ""}-${d.diameterMax || ""}mmï¼ˆä¸æ­£å††ç‡ï¼š${unevenRate}ï¼‰ã€€é«˜ã•ï¼š${d.height || ""}mmï¼ˆå…¨é«˜æ¯”ï¼š${heightRatio}ï¼‰
            </td>
          `;
          tbody.appendChild(detailRow);

          row.querySelector(".detailToggle").addEventListener("click", () => {
            detailRow.style.display = detailRow.style.display === "table-row" ? "none" : "table-row";
          });
        });

        const msg = results.length
          ? `ğŸ”¹æ¤œç´¢çµæœï¼š<strong>${results.length.toLocaleString()}</strong> ä»¶ï¼ˆ${page}/${totalPages}ãƒšãƒ¼ã‚¸ï¼‰`
          : `âš  è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;

        countTop.innerHTML = msg;
        countBottom.innerHTML = msg;
      }

      const pagination = document.getElementById("paginationArea") || document.createElement("div");
      pagination.id = "paginationArea";
      pagination.className = "pagination stylish-pagination";
      countBottom.insertAdjacentElement("afterend", pagination);

      function updatePagination() {
        pagination.innerHTML = "";
        if (totalPages <= 1) return;

        const prev = document.createElement("button");
        prev.textContent = "â† å‰ã¸";
        prev.disabled = currentPage === 1;
        prev.onclick = () => { currentPage--; renderPage(currentPage); updatePagination(); };

        const next = document.createElement("button");
        next.textContent = "æ¬¡ã¸ â†’";
        next.disabled = currentPage === totalPages;
        next.onclick = () => { currentPage++; renderPage(currentPage); updatePagination(); };

        const info = document.createElement("span");
        info.innerHTML = `ãƒšãƒ¼ã‚¸ ${currentPage} / ${totalPages}`;

        pagination.append(prev, info, next);
      }

      renderPage(1);
      updatePagination();
      spinner.style.display = "none";

    }, 100);
  });

  // ---------------------
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  // ---------------------
  document.getElementById("clearButton").addEventListener("click", () => {
    ["minCarat", "maxCarat", "mainCarat", "dateSelect", "fromColor", "toColor", "fancyGradeSelect", "fancyToneSelect", "claritySelect", "cutSelect", "fluorescenceSelect", "shapeSelect", "keyword"]
      .forEach(id => document.getElementById(id).value = "");
    document.getElementById("resultBody").innerHTML = "";
  });
</script>
</body>
</html>
